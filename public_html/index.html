<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>メトロノーム</title>
<meta name="description" content="">
<meta name="keywords" content="">
<meta name="robots" contents="noindex,nofollow">

<link href="https://fonts.googleapis.com/css?family=Pacifico" rel="stylesheet">

<link href="./css/materialize.css" rel="stylesheet" type="text/css" media="all">
<link href="./css/common.css" rel="stylesheet" type="text/css" media="all">
<link href="./css/styles.css" rel="stylesheet" type="text/css" media="all">
<link rel="shortcut icon" href="./images/favicon.ico"> 

<!-- jQuery library (served from Google) -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script>
<script src="./js/materialize.js" type="text/javascript"></script>

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">

<meta name="viewport" content="width=device-width,initial-scale=1">
	
</head>
<body>

<div class="wrapper">

	<div class="left_side">
		<!--<p class="flash">●</p>-->
		<div class="anime1">
			<p class="frame0"><img src="./images/crossing0.png"></p>
			<p class="frame1"><img src="./images/crossing1.png"></p>
			<p class="frame2"><img src="./images/crossing2.png"></p>
		</div>
	</div>
	
	<div class="right_side">	
	
		<div class="right_side_wrapper">
	
			<h1 class="center logo">Metronome</h1>
		
			<div class="display">
				<div class="tempo">120</div>
			</div>
			
			<div class="time_signature">
				<p class="center">4/4</p>
			</div>	
			
			<div class="flex_list ctrl_panel">
				<div class="player">
					<ul class="flex_list">
						<li class="play"><i class="fas fa-play"></i></li>
						<li class="stop"><i class="fas fa-stop"></i></li>
					</ul>
				</div>
				
				<div class="speed_ctrl">
					<ul class="flex_list">
						<li class="tempo1_down"><</li>
						<li class="tempo1_up">></li>
					</ul>
					<ul class="flex_list">
						<li class="tempo5_down">-5</li>
						<li class="tempo5_up">+5</li>
					</ul>
				</div>
			</div>
			
			<div class="prog center">		
				<!--
				<p class="training_trigger">Training mode</p>
				<div class="training">			
					<input type="text">～<input type="text">
					
					<input type="text">bars
				</div>
				-->

				<div class="silent">
				  <div class="input-field col s12">
				    <select class="silent_select">
				      <option value="0" selected>Enable Silent Bars</option>
				      <option value="1">1</option>
				      <option value="2">2</option>
				      <option value="3">3</option>
				      <option value="4">4</option>
				    </select>
				  </div>
				</div>
		
			</div>

		
		</div>		
	
	</div>

</div>

<script>
$(document).ready(function(){
  $('select').formSelect();
});



/*-----------------------------------------------
// スマホではtouchend,PCではclickを取得するようにする    
-------------------------------------------------*/
let isTouchDevice = (('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch);

//デバイス判定によるイベントの決定
let eventType = (isTouchDevice) ? 'touchend' : 'click';

let first_click = true;

/*-----------------------------------------------
// 低い音の準備
-------------------------------------------------*/
const context = new(window.AudioContext||window.webkitAudioContext)();
const osc = context.createOscillator();
const gain = context.createGain();




/*-----------------------------------------------
// 高い音の準備
-------------------------------------------------*/
const context2 = new(window.AudioContext||window.webkitAudioContext)();
const osc2 = context2.createOscillator();
const gain2 = context2.createGain();


/*-----------------------------------------------
// 再生処理 
-------------------------------------------------*/
$('.play').click(function(){
  if ( first_click == true ) {
	// 音程
	osc.frequency.value = 1200;
	// 音量を0にしておく
	gain.gain.value = 0;

	// 設定を適用
	osc.connect(gain);
	gain.connect(context.destination);

    // 裏で鳴らしておく
    osc.start(0);
	
	// 音程
	osc2.frequency.value = 1400;
	// 音量を0にしておく
	gain2.gain.value = 0;

	// 設定を適用
	osc2.connect(gain2);
	gain2.connect(context2.destination);

    // 裏で鳴らしておく
    osc2.start(0);
  }

  first_click = false;
  isPlaying = true;
  $('.play').hide();
  $('.stop').show();
  playOn(tempo);
});

$('.tempo').click(function(){

});

/*-----------------------------------------------
// 停止処理   
-------------------------------------------------*/
$('.stop').on(eventType, function(){
  $('.stop').hide();
  $('.play').show();
  isPlaying = false;
  clearInterval(timer1);
  gain.gain.cancelScheduledValues(context.currentTime);
  gain2.gain.cancelScheduledValues(context.currentTime);
  $('.anime1 .frame1').hide();
  $('.anime1 .frame2').hide();
  $('.anime1 .frame0').show();
});

// テンポ設定
let tempo = 120;

/*-----------------------------------------------
// テンポ操作
-------------------------------------------------*/
$('.tempo1_up').on(eventType, function(){
  tempo = tempo + 1;
  $('.tempo').text(tempo);
});

$('.tempo1_down').on(eventType, function(){
  tempo = tempo - 1;
  $('.tempo').text(tempo);
});

$('.tempo5_up').on(eventType, function(){
  tempo = tempo + 5;
  $('.tempo').text(tempo);
});

$('.tempo5_down').on(eventType, function(){
  tempo = tempo - 5;
  $('.tempo').text(tempo);
});

/*-----------------------------------------------
// クロックの設定
-------------------------------------------------*/
// Memorize AudioContext start time in DOMHighResTimeStamp
const base_time = performance.now() - context.currentTime * 1000;

// Function to return context's currentTime in DOMHighResTimeStamp
function current_time() {
  return base_time + context.currentTime * 1000;
}

// Function to convert DOMHighResTimeStamp to AudioContext currenTime
function timestamp_to_audioctx(timeStamp) {
  return (timeStamp - base_time) / 1000;
}

/*-----------------------------------------------
// スケジューリング
-------------------------------------------------*/
function playOn(tempo) {


  let count = 0;
  let silent_stock = 0;

  // The last scheduled click's time in DOMHighResTimeStamp
  let lastClickTimeStamp = performance.now();

  timer1 = setInterval(() => {
    let tick = 60 * 1000 / tempo;  // for tempo=120
    let silent_bar = $(".silent_select").val();

    const now = current_time();

      for (let nextClickTimeStamp = lastClickTimeStamp + tick;
        nextClickTimeStamp < now + 1500;
        nextClickTimeStamp += tick) {

        // 次回の発音時間
        const nextClickTime = timestamp_to_audioctx(nextClickTimeStamp);
        
        if ( silent_stock < ( silent_bar * 4 ) || silent_bar == 0 ) {

          //　小節の頭であれば高い音を鳴らす
          if ( count % 4 == 0 ) { 
          gain2.gain.setValueAtTime(1, nextClickTime);

          //　その後素早く(0.05秒で)音の減衰をさせる(ピーではなくピッという音にするため)
          gain2.gain.linearRampToValueAtTime(0, nextClickTime + 0.05);
          } else {    
          gain.gain.setValueAtTime(1, nextClickTime);

          //　その後素早く(0.05秒で)音の減衰をさせる(ピーではなくピッという音にするため)
          gain.gain.linearRampToValueAtTime(0, nextClickTime + 0.05);
        }

      }

        count = count + 1;
      silent_stock = silent_stock + 1;

        if ( silent_stock == ( silent_bar * 4 ) * 2 ) { 
          silent_stock = 0;
        }
        
        // 今鳴らし終えた地点を最後の発音として記録
        lastClickTimeStamp = nextClickTimeStamp;
    }


  }, ( 60 * 1000 / tempo ) /2);
}

	
</script>